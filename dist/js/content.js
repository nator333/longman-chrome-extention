(()=>{"use strict";var t={90:(t,e,i)=>{i.d(e,{G:()=>s});var n=i(921),o=i(185);class s{static async fetchMainDictionary(t){try{const e=`${this.MAIN_API_ENDPOINT}?limit=5&headword=${encodeURIComponent(t)}`;o.vF.debug("Fetching main dictionary data",{word:t,url:e});const i=await this.makeRequest(e),n=await i.json();return this.processMainApiResponse(n,t)}catch(t){throw o.vF.error("Failed to fetch main dictionary data",t),new Error(`Dictionary lookup failed: ${t instanceof Error?t.message:"Unknown error"}`)}}static async fetchSynonyms(t){try{const e=`${this.MAIN_API_ENDPOINT}?limit=5&synonyms=${encodeURIComponent(t)}`;o.vF.debug("Fetching synonym data",{word:t,url:e});const i=await this.makeRequest(e),n=await i.json();return this.processSynonymApiResponse(n,t)}catch(t){return o.vF.error("Failed to fetch synonym data",t),{}}}static async makeRequest(t){const e=new AbortController,i=setTimeout(()=>e.abort(),this.REQUEST_TIMEOUT);try{const n=await fetch(t,{signal:e.signal,method:"GET",headers:{Accept:"application/json"}});if(clearTimeout(i),!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return n}catch(t){if(clearTimeout(i),t instanceof Error&&"AbortError"===t.name)throw new Error("Request timeout");throw t}}static processMainApiResponse(t,e){const i=[];if(!t.total||0===t.total)return o.vF.debug("No results found for word",{searchWord:e}),i;for(const o of t.results){if(e!==o.headword)continue;const t={headword:o.headword,url:`${n.Sn.LONGMAN_DICTIONARY}${o.headword}`};if(o.part_of_speech&&(t.partOfSpeech=o.part_of_speech),o.pronunciations){const e=this.extractAmericanPronunciation(o.pronunciations);e&&(t.ipa=e.ipa,t.audio=e.audio)}if(o.senses&&o.senses[0]){const e=this.extractSenseData(o.senses[0]);Object.assign(t,e)}i.push(t)}return o.vF.debug("Processed main API response",{searchWord:e,resultCount:i.length}),i}static extractAmericanPronunciation(t){if(1===t.length&&t[0].audio)for(const e of t[0].audio)if("American English"===e.lang)return{ipa:t[0].ipa,audio:`${n.Sn.PEARSON_DOMAIN}${e.url}`};for(const e of t)if("American English"===e.lang&&e.ipa){let t;return e.audio&&e.audio.length>0&&(t=`${n.Sn.PEARSON_DOMAIN}${e.audio[0].url}`),{ipa:e.ipa,audio:t}}return null}static extractSenseData(t){const e={};for(const[i,o]of Object.entries(t))Array.isArray(o)?"object"==typeof o[0]&&null!==o[0]&&"text"in o[0]?e.example={text:`ex) ${o[0].text}`,audio:o[0].audio?`${n.Sn.PEARSON_DOMAIN}${o[0].audio[0].url}`:void 0}:"string"==typeof o[0]&&(e.definition=o[0]):"object"==typeof o&&null!==o&&"type"in o?e.grammaticalInfo=o.type:"synonym"===i&&"string"==typeof o&&(e.synonym=o);return e}static processSynonymApiResponse(t,e){const i={};if(!t.total||0===t.total)return i;for(const n of t.results){if(!n.part_of_speech||!n.headword||e===n.headword)continue;const t=`synonyms-${n.part_of_speech.replace(/\s+/g,"")}`;i[t]||(i[t]=[]);const o={headword:n.headword,definition:this.extractDefinitionFromSense(n.senses)};i[t].push(o)}return o.vF.debug("Processed synonym API response",{searchWord:e,synonymCount:Object.keys(i).length}),i}static extractDefinitionFromSense(t){if(!t||!Array.isArray(t)||!t[0])return;const e=t[0];for(const t of Object.values(e))if(Array.isArray(t)&&"string"==typeof t[0])return t[0]}}s.MAIN_API_ENDPOINT=`${n.Sn.PEARSON_DOMAIN}/v2/dictionaries/ldoce5/entries`,s.REQUEST_TIMEOUT=1e4},185:(t,e,i)=>{function n(t){const e=t.replace(/[\.\*\?;!()\+,\[:\]<>^_`\[\]{}~\\\/\"\'=]/g," ").trim();return e&&!e.includes(" ")&&e.match(/^[a-zA-Z]+$/)?e.endsWith("day")?e:e.toLowerCase():null}function o(t){const e=t.tagName.toLowerCase();return"input"===e||"textarea"===e}function s(){try{return window.getSelection()}catch(t){return console.warn("Failed to get window selection:",t),null}}function l(t,e,i){const n=document.createElement(t);return e&&n.classList.add(...e),i&&Object.entries(i).forEach(([t,e])=>{n.setAttribute(t,e)}),n}function a(t,e){try{const i=e||t.parentElement;return!(!i||!i.contains(t)||(i.removeChild(t),0))}catch(t){return console.warn("Failed to remove element:",t),!1}}i.d(e,{B6:()=>o,OC:()=>n,n:()=>l,sX:()=>a,sb:()=>r,tb:()=>s,vF:()=>d});const d={debug:(t,...e)=>{"undefined"!=typeof console&&console.debug&&console.debug(`[LMD Debug] ${t}`,...e)},info:(t,...e)=>{console.info(`[LMD Info] ${t}`,...e)},warn:(t,...e)=>{console.warn(`[LMD Warning] ${t}`,...e)},error:(t,e)=>{console.error(`[LMD Error] ${t}`,e)}};function r(t){return t instanceof HTMLElement}},921:(t,e,i)=>{i.d(e,{B6:()=>d,B8:()=>s,Sn:()=>o,d5:()=>a,iP:()=>n,lJ:()=>l});const n={WIDTH:450,HEIGHT:300},o={PEARSON_DOMAIN:"https://api.pearson.com",LONGMAN_DICTIONARY:"https://www.ldoceonline.com/dictionary/"},s={EXAMPLE_PREFIX:"ex) ",TOP_ADJUSTMENT_PX:12,ICON_OFFSET:12,SELECTION_HEIGHT_OFFSET:28},l={LMD:"lmd",LMD_ICON:"lmd-icon",LMD_ICON_IMG:"lmd-icon-img",LMD_BUBBLE:"lmd-bubble",LMD_AUDIO_IMG:"lmd-audio-img",LMD_CLOSE_BTN:"lmd-close-btn",LMD_FOOTER:"lmd-footer",LMD_A:"lmd-a"},a={IS_DISABLE:"lmdIsDisable",SHOW_ICON_FIRST:"lmdShowIconFirst",PRONUNCIATION:"lmdPronunciation"},d={BUBBLE_DIV:"lmd-bubble",CLOSE_BTN:"lmd-close-btn"}}},e={};function i(n){var o=e[n];if(void 0!==o)return o.exports;var s=e[n]={exports:{}};return t[n](s,s.exports,i),s.exports}i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var n=i(921),o=i(185),s=i(90);new class{constructor(){this.documentBody=document.body,this.documentElement=document.documentElement,this.bubbleDivs=[],this.isIconAdded=!1,this.bubbleDiv=void 0,this.selectionText="",this.selectionClientX=0,this.selectionBoundingClientRect=void 0,this.iconDiv=(0,o.n)("div",[n.lJ.LMD_ICON]),this.imageDiv=(0,o.n)("div",[n.lJ.LMD_ICON_IMG]),this.iconDiv.appendChild(this.imageDiv),this.initialize()}async initialize(){try{const t=await chrome.storage.local.get([n.d5.IS_DISABLE]);if(this.documentElement.lang&&!this.documentElement.lang.includes("en"))return void o.vF.debug("Page language is not English, extension disabled");t[n.d5.IS_DISABLE]||(this.documentBody.addEventListener("mouseup",this.handleMouseUp.bind(this),!1),o.vF.debug("Extension initialized and event listeners attached"))}catch(t){o.vF.error("Failed to initialize extension",t)}}async handleMouseUp(t){const e=t.target;if(!this.bubbleDiv||e.classList.contains(n.lJ.LMD)){if(!(0,o.B6)(e))try{(await chrome.storage.local.get([n.d5.SHOW_ICON_FIRST]))[n.d5.SHOW_ICON_FIRST]?setTimeout(()=>this.displayIcon(t),10):setTimeout(()=>this.displayBubble(t),10)}catch(t){o.vF.error("Failed to handle mouse up event",t)}}else this.closeAllBubbles()}closeAllBubbles(){this.bubbleDivs.forEach(t=>{(0,o.sX)(t,this.documentBody)}),this.bubbleDivs.length=0,this.bubbleDiv=void 0}displayIcon(t){const e=(0,o.tb)();if(!e)return;const i=(0,o.OC)(e.toString());i?t.target!==this.iconDiv&&(this.selectionText=i,this.selectionClientX=t.clientX,this.selectionBoundingClientRect=e.getRangeAt(0).getBoundingClientRect(),this.positionIcon(t),this.iconDiv.addEventListener("click",this.handleIconClick.bind(this),!1),this.documentBody.appendChild(this.iconDiv),this.isIconAdded=!0,o.vF.debug("Icon displayed for word",{word:i})):this.hideIcon()}positionIcon(t){if(!this.selectionBoundingClientRect)return;const e=this.documentBody.parentNode.getBoundingClientRect();let i=-1;Math.abs(t.clientY-this.selectionBoundingClientRect.top)>this.selectionBoundingClientRect.bottom-t.clientY&&(i=this.selectionBoundingClientRect.height+n.B8.SELECTION_HEIGHT_OFFSET),this.iconDiv.style.top=this.selectionBoundingClientRect.bottom-e.top-i+"px",this.iconDiv.style.left=t.clientX+this.documentElement.scrollLeft-n.B8.ICON_OFFSET+"px"}hideIcon(){this.isIconAdded&&((0,o.sX)(this.iconDiv,this.documentBody),this.isIconAdded=!1)}displayBubble(t){const e=(0,o.tb)();if(!e)return;const i=(0,o.OC)(e.toString());i&&!i.includes(" ")&&(this.selectionText=i,this.selectionClientX=t.clientX,this.selectionBoundingClientRect=e.getRangeAt(0).getBoundingClientRect(),this.requestDictionaryData())}handleIconClick(t){this.hideIcon(),t.stopPropagation(),t.preventDefault(),this.requestDictionaryData()}async requestDictionaryData(){try{o.vF.debug("Requesting dictionary data",{word:this.selectionText});const[t,e]=await Promise.allSettled([s.G.fetchMainDictionary(this.selectionText),s.G.fetchSynonyms(this.selectionText)]),i="fulfilled"===t.status?t.value:[],n="fulfilled"===e.status?e.value:{};this.displayDictionaryBubble(i,n)}catch(t){o.vF.error("Failed to fetch dictionary data",t),this.displayErrorBubble()}}displayDictionaryBubble(t,e){this.bubbleDiv=this.createBubbleContainer();const i=this.createContentContainer();this.addHeadword(i),t.length>0?this.addDictionaryEntries(i,t,e):this.addNotFoundMessage(i),this.addFooter(i),this.bubbleDiv.appendChild(i),this.documentBody.appendChild(this.bubbleDiv),setTimeout(()=>this.positionBubble(),50)}displayErrorBubble(){this.bubbleDiv=this.createBubbleContainer();const t=this.createContentContainer();this.addHeadword(t);const e=(0,o.n)("div",[n.lJ.LMD]);e.innerHTML="Failed to load dictionary data. Please try again.",e.style.color="red",t.appendChild(e),this.addFooter(t),this.bubbleDiv.appendChild(t),this.documentBody.appendChild(this.bubbleDiv),setTimeout(()=>this.positionBubble(),50)}createBubbleContainer(){const t=(0,o.n)("div",[n.lJ.LMD,n.lJ.LMD_BUBBLE]);return this.bubbleDivs.push(t),t.id=`${n.B6.BUBBLE_DIV}-${this.bubbleDivs.length}`,t.style.width=`${n.iP.WIDTH}px`,t.style.height=`${n.iP.HEIGHT}px`,t.style.cssText+="z-index: 999999999 !important;",t.style.position="absolute",t.style.visibility="visible",t.style.opacity="0",this.addCloseButton(t),t}addCloseButton(t){const e=(0,o.n)("div",[n.lJ.LMD,n.lJ.LMD_CLOSE_BTN]);e.id=`${n.B6.CLOSE_BTN}-${this.bubbleDivs.length}`,e.addEventListener("click",t=>{const e=t.target,i=`${n.B6.BUBBLE_DIV}${e.id.replace(n.B6.CLOSE_BTN,"")}`;this.bubbleDivs.forEach(t=>{t.id===i&&((0,o.sX)(t,this.documentBody),this.bubbleDiv=void 0)})},!1),t.appendChild(e)}createContentContainer(){const t=(0,o.n)("div",[n.lJ.LMD]);return t.style.minWidth="200px",t.style.maxWidth="400px",t}addHeadword(t){const e=(0,o.n)("div",[n.lJ.LMD]);e.innerHTML=this.selectionText,e.style.cssText+="font-size: 30px !important;",e.style.fontWeight="bold",e.style.color="blue",t.appendChild(e);const i=(0,o.n)("hr");i.style.margin="1px",t.appendChild(i)}addDictionaryEntries(t,e,i){e.forEach((n,s)=>{if(n.partOfSpeech&&this.addPartOfSpeech(t,n),n.audio&&this.addAudioButton(t,n.audio),n.ipa&&this.addIPA(t,n.ipa),n.definition&&this.addDefinition(t,n.definition),n.example&&this.addExample(t,n.example),this.addSynonyms(t,n,i),s<e.length-1){const e=(0,o.n)("hr");e.style.margin="1px",t.appendChild(e)}})}addPartOfSpeech(t,e){const i=(0,o.n)("div",[n.lJ.LMD]),s=e.partOfSpeech;i.innerHTML=`- ${s.charAt(0).toUpperCase()}${s.slice(1)}`,e.grammaticalInfo&&(i.innerHTML+=` (${e.grammaticalInfo})`),i.style.fontStyle="italic",i.style.display="inline-block",i.style.paddingRight="15px",t.appendChild(i)}addAudioButton(t,e){const i=(0,o.n)("audio",[n.lJ.LMD]);i.src=e,i.preload="auto";const s=(0,o.n)("div",[n.lJ.LMD]);s.style.display="inline-block",s.addEventListener("click",()=>i.play().catch(o.vF.error),!1);const l=(0,o.n)("div",[n.lJ.LMD,n.lJ.LMD_AUDIO_IMG]);s.appendChild(l),t.appendChild(s)}addIPA(t,e){const i=(0,o.n)("div",[n.lJ.LMD]);i.style.display="inline-block",i.innerHTML=e,t.appendChild(i)}addDefinition(t,e){const i=(0,o.n)("div",[n.lJ.LMD]);i.innerHTML=e,i.style.paddingLeft="15px",i.style.fontWeight="bold",t.appendChild(i)}addExample(t,e){if(e.audio){const i=(0,o.n)("audio",[n.lJ.LMD]);i.src=e.audio,i.preload="auto";const s=(0,o.n)("div",[n.lJ.LMD]);s.style.display="inline-block",s.style.verticalAlign="top",s.style.paddingLeft="15px",s.onclick=()=>i.play().catch(o.vF.error);const l=(0,o.n)("div",[n.lJ.LMD,n.lJ.LMD_AUDIO_IMG]);s.appendChild(l),t.appendChild(s)}const i=(0,o.n)("div",[n.lJ.LMD]);i.innerHTML=e.text,i.style.display="inline-block",i.style.color="blue",i.style.width="360px",t.appendChild(i)}addSynonyms(t,e,i){const s=(0,o.n)("div",[n.lJ.LMD]);if(s.innerHTML="Synonyms: ",e.partOfSpeech){const t=`synonyms-${e.partOfSpeech.replace(/\s+/g,"")}`;s.classList.add(t),i[t]&&i[t].length>0&&i[t].forEach((e,n)=>{const l=(0,o.n)("span");l.innerHTML=e.headword,e.definition&&(l.title=e.definition),s.appendChild(l),n<i[t].length-1&&s.appendChild(document.createTextNode(", "))})}if(s.style.fontStyle="italic",s.style.paddingLeft="15px",s.style.color="#6b6060",s.style.display=e.synonym||i[`synonyms-${e.partOfSpeech?.replace(/\s+/g,"")||""}`]?"":"none",e.synonym){const t=(0,o.n)("div");t.style.display="inline-block",t.innerHTML=e.synonym,s.appendChild(t)}t.appendChild(s)}addNotFoundMessage(t){const e=(0,o.n)("div",[n.lJ.LMD]);e.innerHTML="Not Found",t.appendChild(e)}addFooter(t){const e=(0,o.n)("div",[n.lJ.LMD,n.lJ.LMD_FOOTER]);e.style.paddingTop="3px";const i=(0,o.n)("a",[n.lJ.LMD,n.lJ.LMD_A]);i.href=`https://www.ldoceonline.com/dictionary/${this.selectionText}`,i.innerHTML="More >>",i.target="_blank",i.style.cursor="pointer",i.addEventListener("focus",t=>{(0,o.sb)(t.target)&&t.target.blur()},!1),e.appendChild(i),t.appendChild(e)}positionBubble(){if(!this.bubbleDiv||!this.selectionBoundingClientRect)return;const t=this.bubbleDiv.getBoundingClientRect().width/2;let e=0,i="";this.selectionClientX+t>this.documentBody.clientWidth?(i="right-",e=this.selectionBoundingClientRect.right-this.bubbleDiv.getBoundingClientRect().width):t>this.selectionClientX?(e=this.selectionBoundingClientRect.left,i="left-"):e=this.selectionClientX+this.documentElement.scrollLeft-t,this.bubbleDiv.style.left=`${e}px`;let s=0;this.selectionBoundingClientRect.top<this.bubbleDiv.getBoundingClientRect().height+n.B8.TOP_ADJUSTMENT_PX?(s=this.documentElement.scrollTop+this.selectionBoundingClientRect.bottom+n.B8.TOP_ADJUSTMENT_PX,this.bubbleDiv.classList.add(`lower-${i}arrow`)):(s=this.documentElement.scrollTop+this.selectionBoundingClientRect.top-(this.bubbleDiv.getBoundingClientRect().height+n.B8.TOP_ADJUSTMENT_PX),this.bubbleDiv.classList.add(`upper-${i}arrow`)),this.bubbleDiv.style.top=`${s}px`,this.bubbleDiv.style.opacity="1",o.vF.debug("Bubble positioned",{position:{left:e,top:s}})}}})();